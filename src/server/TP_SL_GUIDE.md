# 止盈止损设置指南

## 📋 问题说明

### 错误示例

```
Bybit API错误: TakeProfit:34643000 set for Sell position should be lower than base_price:34301100
```

**原因**：做空订单的止盈价格设置错误，止盈价应该**低于**开仓价，而不是高于。

## 🎯 核心概念

### 做多（Buy）vs 做空（Sell）

| 操作 | 盈利方向 | 止盈价 | 止损价 |
|------|---------|--------|--------|
| **做多 (Buy)** | 价格上涨赚钱 | **高于**开仓价 | **低于**开仓价 |
| **做空 (Sell)** | 价格下跌赚钱 | **低于**开仓价 | **高于**开仓价 |

## 📊 详细说明

### 1. 做多（ENTER_LONG / Buy）

**场景**：你认为价格会上涨

```javascript
// 示例：在 3400 开多仓
{
  "symbol": "ETHUSDT",
  "side": "ENTER_LONG",  // 做多
  "qty": "0.01",
  "price": "3400",       // 开仓价
  "takeProfit": "3500",  // ✅ 止盈：3500 > 3400（价格涨到3500止盈）
  "stopLoss": "3300"     // ✅ 止损：3300 < 3400（价格跌到3300止损）
}
```

**逻辑**：
- 开仓价：3400
- 价格涨到 3500 → 赚了 100 → 止盈平仓
- 价格跌到 3300 → 亏了 100 → 止损平仓

### 2. 做空（ENTER_SHORT / Sell）

**场景**：你认为价格会下跌

```javascript
// 示例：在 3400 开空仓
{
  "symbol": "ETHUSDT",
  "side": "ENTER_SHORT", // 做空
  "qty": "0.01",
  "price": "3400",       // 开仓价
  "takeProfit": "3300",  // ✅ 止盈：3300 < 3400（价格跌到3300止盈）
  "stopLoss": "3500"     // ✅ 止损：3500 > 3400（价格涨到3500止损）
}
```

**逻辑**：
- 开仓价：3400
- 价格跌到 3300 → 赚了 100 → 止盈平仓
- 价格涨到 3500 → 亏了 100 → 止损平仓

## ❌ 常见错误

### 错误 1：做空时止盈价高于开仓价

```javascript
// ❌ 错误示例
{
  "side": "ENTER_SHORT",
  "price": "3400",
  "takeProfit": "3500",  // ❌ 错误！做空时止盈应该低于开仓价
  "stopLoss": "3300"     // ❌ 错误！做空时止损应该高于开仓价
}

// ✅ 正确示例
{
  "side": "ENTER_SHORT",
  "price": "3400",
  "takeProfit": "3300",  // ✅ 正确！价格跌到3300止盈
  "stopLoss": "3500"     // ✅ 正确！价格涨到3500止损
}
```

### 错误 2：做多时止盈价低于开仓价

```javascript
// ❌ 错误示例
{
  "side": "ENTER_LONG",
  "price": "3400",
  "takeProfit": "3300",  // ❌ 错误！做多时止盈应该高于开仓价
  "stopLoss": "3500"     // ❌ 错误！做多时止损应该低于开仓价
}

// ✅ 正确示例
{
  "side": "ENTER_LONG",
  "price": "3400",
  "takeProfit": "3500",  // ✅ 正确！价格涨到3500止盈
  "stopLoss": "3300"     // ✅ 正确！价格跌到3300止损
}
```

## 🔧 系统自动检测

现在系统会自动检测止盈止损设置是否正确：

```javascript
// 如果设置错误，会输出警告并移除错误的止盈止损
⚠️  做空订单止盈价格错误: 3500 > 3400，止盈价应该低于开仓价
   建议：如果想在价格跌到 3300 时止盈，请将止盈价设为低于 3400 的值

⚠️  做空订单止损价格错误: 3300 < 3400，止损价应该高于开仓价
   建议：如果想在价格涨到 3500 时止损，请将止损价设为高于 3400 的值
```

## 📝 完整示例

### 示例 1：做多 ETH

```javascript
// 场景：ETH 当前价格 3400，你认为会涨到 3600
// 策略：在 3410 开多，目标 3600，止损 3350

POST /webhook
{
  "symbol": "ETHUSDT",
  "side": "ENTER_LONG",
  "qty": "0.01",
  "price": "3410",       // 限价单：3410 开仓
  "takeProfit": "3600",  // 止盈：涨到 3600
  "stopLoss": "3350"     // 止损：跌到 3350
}

// 结果：
// - 价格涨到 3600 → 盈利 190 USDT (0.01 * 190)
// - 价格跌到 3350 → 亏损 60 USDT (0.01 * 60)
```

### 示例 2：做空 ETH

```javascript
// 场景：ETH 当前价格 3400，你认为会跌到 3200
// 策略：在 3390 开空，目标 3200，止损 3450

POST /webhook
{
  "symbol": "ETHUSDT",
  "side": "ENTER_SHORT",
  "qty": "0.01",
  "price": "3390",       // 限价单：3390 开仓
  "takeProfit": "3200",  // 止盈：跌到 3200
  "stopLoss": "3450"     // 止损：涨到 3450
}

// 结果：
// - 价格跌到 3200 → 盈利 190 USDT (0.01 * 190)
// - 价格涨到 3450 → 亏损 60 USDT (0.01 * 60)
```

### 示例 3：市价单开仓

```javascript
// 使用市价单快速开仓
POST /webhook
{
  "symbol": "ETHUSDT",
  "side": "ENTER_LONG",
  "qty": "0.01",
  "price": "0",          // 市价单
  "takeProfit": "3600",  // 止盈
  "stopLoss": "3300"     // 止损
}

// 注意：市价单时，止盈止损基于实际成交价
```

## 💡 计算止盈止损

### 方法 1：固定金额

```javascript
// 开仓价 3400，想赚 200 USDT，愿意亏 100 USDT

// 做多
takeProfit = 3400 + 200 = 3600
stopLoss = 3400 - 100 = 3300

// 做空
takeProfit = 3400 - 200 = 3200
stopLoss = 3400 + 100 = 3500
```

### 方法 2：百分比

```javascript
// 开仓价 3400，止盈 5%，止损 2%

// 做多
takeProfit = 3400 * (1 + 0.05) = 3570
stopLoss = 3400 * (1 - 0.02) = 3332

// 做空
takeProfit = 3400 * (1 - 0.05) = 3230
stopLoss = 3400 * (1 + 0.02) = 3468
```

### 方法 3：风险回报比

```javascript
// 风险回报比 1:2（愿意亏 1 块，期望赚 2 块）
// 开仓价 3400，止损距离 100

// 做多
stopLoss = 3400 - 100 = 3300
takeProfit = 3400 + (100 * 2) = 3600

// 做空
stopLoss = 3400 + 100 = 3500
takeProfit = 3400 - (100 * 2) = 3200
```

## 🎓 记忆技巧

### 简单记忆法

**做多（Buy）**：
- 想法：买入后希望价格**涨**
- 止盈：价格涨到目标 → **高于**开仓价
- 止损：价格跌破支撑 → **低于**开仓价

**做空（Sell）**：
- 想法：卖出后希望价格**跌**
- 止盈：价格跌到目标 → **低于**开仓价
- 止损：价格涨破阻力 → **高于**开仓价

### 图示

```
做多（Buy）：
         ↑ 止盈 (3500)
         |
    ---- 开仓价 (3400) ----
         |
         ↓ 止损 (3300)

做空（Sell）：
         ↑ 止损 (3500)
         |
    ---- 开仓价 (3400) ----
         |
         ↓ 止盈 (3300)
```

## 🚀 最佳实践

### 1. 合理的止盈止损比例

```javascript
// 推荐：风险回报比至少 1:1.5 或 1:2
// 例如：愿意亏 100，期望赚 150-200

// 做多示例（开仓价 3400）
{
  "stopLoss": "3300",    // 风险：100 USDT
  "takeProfit": "3600"   // 回报：200 USDT
}
// 风险回报比 = 200/100 = 2:1 ✅
```

### 2. 不要设置过近的止损

```javascript
// ❌ 不推荐：止损太近，容易被震出
{
  "price": "3400",
  "stopLoss": "3395"  // 只有 5 USDT 的空间
}

// ✅ 推荐：给予合理的波动空间
{
  "price": "3400",
  "stopLoss": "3350"  // 50 USDT 的空间
}
```

### 3. 根据波动率调整

```javascript
// 高波动币种（如山寨币）：止损距离可以大一些
// 低波动币种（如BTC、ETH）：止损距离可以小一些

// BTC 示例（波动较小）
{
  "price": "50000",
  "takeProfit": "51000",  // 2%
  "stopLoss": "49500"     // 1%
}

// 山寨币示例（波动较大）
{
  "price": "1.00",
  "takeProfit": "1.10",   // 10%
  "stopLoss": "0.95"      // 5%
}
```

## 📄 许可证

MIT

